# 实验三：IGMP 协议软件（路由器端）开发 - 运行指南

## 📁 文件结构

```
Experiment3/
├── IGMPv2模块需求分析.md    # 需求分析文档
├── IGMPv2模块概要设计.md    # 概要设计文档
├── README.md                # 本指南
└── code/
    ├── igmp.h              # 公共头文件
    ├── igmp_main.c         # 主程序
    ├── igmp_socket.c       # 报文收发模块
    ├── igmp_proto.c        # 协议处理模块
    ├── igmp_group.c        # 组成员表模块
    ├── host_simulator.c    # 主机模拟器
    └── Makefile
```

---

## 🖥️ 实验环境

需要 **两台 Ubuntu 虚拟机**（或同一台使用两个终端）：

| 虚拟机 | 角色   | 运行程序         |
| ------ | ------ | ---------------- |
| VM1    | 路由器 | `igmp_router`    |
| VM2    | 主机   | `host_simulator` |

---

## 🚀 运行步骤

### 第一步：复制代码到虚拟机

将 `Experiment3/code/` 目录复制到 Ubuntu 虚拟机。

### 第二步：编译

```bash
cd ~/Experiment3/code
# 或者共享文件夹路径

make clean
make
```

成功输出：

```
==========================================
[OK] 编译完成: igmp_router
==========================================
[OK] 编译完成: host_simulator
```

### 第三步：运行 IGMP 路由器 (VM1)

```bash
sudo ./igmp_router -i eth0 -v
```

> 注意：将 `eth0` 替换为实际网卡名（用 `ip link show` 查看）

**路由器启动输出：**

```
########################################
#  IGMPv2 路由器 - 实验三              #
#  Advanced Computer Networks Lab      #
########################################

[IGMP] 初始化中...
[IGMP] 网络接口: eth0
[IGMP] 接口 IP: 192.168.x.x
[IGMP] RAW Socket 创建成功 (fd=3)
[IGMP] 组成员表已初始化
[IGMP] 路由器启动成功！
[IGMP] 按 Ctrl+C 退出

[IGMP] 发送初始 General Query...

[IGMP] 等待主机 IGMP Report...
========================================
```

### 第四步：运行主机模拟器 (VM2 或另一个终端)

```bash
sudo ./host_simulator
```

**主机模拟器输出：**

```
########################################
#  IGMP 主机模拟器 - 实验三            #
########################################

[HOST] Socket 创建成功

命令说明:
  join <组地址>   - 加入组播组 (发送 Report)
  leave <组地址>  - 离开组播组 (发送 Leave)
  quit            - 退出

host>
```

### 第五步：测试加入组播组

在主机模拟器中输入：

```
host> join 239.1.1.1
host> join 239.1.1.2
host> join 239.2.2.2
```

**路由器端将显示：**

```
[RECV] ★ Membership Report from 192.168.x.x
       组播组地址: 239.1.1.1
       [新组] 已添加到组成员表

┌────────────────────────────────────────┐
│         当前组播组成员表               │
├────┬─────────────────┬─────────────────┤
│ #  │ 组播组地址      │ 剩余时间(秒)    │
├────┼─────────────────┼─────────────────┤
│ 1  │ 239.1.1.1       │ 260             │
└────┴─────────────────┴─────────────────┘
  共 1 个组播组
```

### 第六步：测试离开组播组

```
host> leave 239.1.1.1
```

### 第七步：截图

在路由器终端执行：

```bash
# 先按 Ctrl+C 停止路由器，然后执行：
clear && echo "=== MAC地址 ===" && ip link show eth0 | grep -E "eth0|ether" && echo "" && echo "=== 组成员表 ===" && cat /tmp/igmp_groups.txt 2>/dev/null || echo "(见上方运行截图)"
```

或者直接截取运行中的终端画面。

---

## 📸 截图要求

截图必须包含：

1. ✅ 路由器收集到的组播组成员信息
2. ✅ MAC 地址信息
3. ⚠️ **必须在同一张图内！**

---

## 🔧 常见问题

### Q: 提示 "需要 root 权限"？

```bash
sudo ./igmp_router -i eth0 -v
```

### Q: 网卡名不是 eth0？

```bash
# 查看网卡名
ip link show

# 使用实际网卡名
sudo ./igmp_router -i ens33 -v
```

### Q: 两台虚拟机通信不了？

确保两台虚拟机在同一网段：

- VMware: 都设置为 "桥接模式" 或 "NAT 模式"
- 检查 IP：`ip addr show`

### Q: 如果只有一台虚拟机？

可以在同一台机器打开两个终端窗口分别运行路由器和主机模拟器。

---

## 📝 命令对照表

| 操作       | 命令                            |
| ---------- | ------------------------------- |
| 编译       | `make`                          |
| 运行路由器 | `sudo ./igmp_router -i eth0 -v` |
| 运行主机   | `sudo ./host_simulator`         |
| 加入组     | `join 239.1.1.1`                |
| 离开组     | `leave 239.1.1.1`               |
| 查看网卡   | `ip link show`                  |
