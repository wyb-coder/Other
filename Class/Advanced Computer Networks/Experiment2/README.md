# å®éªŒäºŒï¼šLinux ç½‘ç»œè®¾å¤‡é©±åŠ¨å¼€å‘å®éªŒ - è¿è¡ŒæŒ‡å—

## ğŸ“ æ–‡ä»¶ç»“æ„

```
Experiment2/code/
â”œâ”€â”€ vnetdev/
â”‚   â”œâ”€â”€ vnetdev.c    # è™šæ‹Ÿç½‘å¡é©±åŠ¨æºç ï¼ˆå·²æ·»åŠ æ‰“å°è¯­å¥ï¼‰
â”‚   â””â”€â”€ Makefile     # é©±åŠ¨ç¼–è¯‘è„šæœ¬
â””â”€â”€ trigger/
    â”œâ”€â”€ raw_trigger.c # RAWå¥—æ¥å£è§¦å‘ç¨‹åº
    â””â”€â”€ Makefile      # è§¦å‘ç¨‹åºç¼–è¯‘è„šæœ¬
```

---

## ğŸ–¥ï¸ ä½¿ç”¨ VMware Ubuntu è™šæ‹Ÿæœºè¿è¡Œ

### ç¬¬ä¸€æ­¥ï¼šå°†ä»£ç å¤åˆ¶åˆ°è™šæ‹Ÿæœº

**æ–¹æ³•ä¸€ï¼šVMware å…±äº«æ–‡ä»¶å¤¹ï¼ˆæ¨èï¼‰**

1. VMware èœå• â†’ è™šæ‹Ÿæœº â†’ è®¾ç½® â†’ é€‰é¡¹ â†’ å…±äº«æ–‡ä»¶å¤¹
2. å‹¾é€‰"æ€»æ˜¯å¯ç”¨"ï¼Œç‚¹å‡»"æ·»åŠ "
3. é€‰æ‹© Windows ä¸­çš„ `Experiment2` æ–‡ä»¶å¤¹
4. åœ¨ Ubuntu ä¸­è®¿é—®ï¼š`/mnt/hgfs/Experiment2/`

**æ–¹æ³•äºŒï¼šç›´æ¥æ‹–æ‹½**

å°† `Experiment2` æ–‡ä»¶å¤¹æ‹–å…¥ Ubuntu æ¡Œé¢

**æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ USB æˆ–å¤åˆ¶åˆ°è™šæ‹Ÿæœºä¸»ç›®å½•**

```bash
# å‡è®¾å·²å¤åˆ¶åˆ°ä¸»ç›®å½•
cd ~/Experiment2/code
```

---

### ç¬¬äºŒæ­¥ï¼šå®‰è£…ç¼–è¯‘ç¯å¢ƒ

æ‰“å¼€ Ubuntu ç»ˆç«¯ï¼Œæ‰§è¡Œï¼š

```bash
# æ›´æ–°è½¯ä»¶æº
sudo apt update

# å®‰è£…ç¼–è¯‘å·¥å…·
sudo apt install build-essential -y

# å®‰è£…å†…æ ¸å¤´æ–‡ä»¶ï¼ˆé‡è¦ï¼ï¼‰
sudo apt install linux-headers-$(uname -r) -y

# éªŒè¯å®‰è£…
ls /lib/modules/$(uname -r)/build
```

å¦‚æœæœ€åä¸€æ¡å‘½ä»¤æ˜¾ç¤ºç›®å½•å†…å®¹ï¼Œè¯´æ˜å®‰è£…æˆåŠŸã€‚

---

### ç¬¬ä¸‰æ­¥ï¼šç¼–è¯‘é©±åŠ¨

```bash
# è¿›å…¥é©±åŠ¨ç›®å½•
cd ~/Experiment2/code/vnetdev
# æˆ–è€…å¦‚æœä½¿ç”¨å…±äº«æ–‡ä»¶å¤¹ï¼š
# cd /mnt/hgfs/Experiment2/code/vnetdev

# æ¸…ç†å¹¶ç¼–è¯‘
make clean
make
```

**æˆåŠŸè¾“å‡ºç¤ºä¾‹ï¼š**

```
==========================================
æ­£åœ¨ç¼–è¯‘è™šæ‹Ÿç½‘ç»œè®¾å¤‡é©±åŠ¨...
å†…æ ¸è·¯å¾„: /lib/modules/5.4.0-xxx/build
==========================================
make[1]: Entering directory '/usr/src/linux-headers-5.4.0-xxx'
...
==========================================
ç¼–è¯‘å®Œæˆ! ç”Ÿæˆ netdrv.ko
==========================================
```

---

### ç¬¬å››æ­¥ï¼šåŠ è½½é©±åŠ¨

```bash
# åŠ è½½é©±åŠ¨æ¨¡å—
sudo insmod netdrv.ko

# å¯åŠ¨è™šæ‹Ÿç½‘å¡
sudo ifconfig vnet0 up

# æŸ¥çœ‹é©±åŠ¨åŠ è½½ä¿¡æ¯
dmesg | tail -30
```

**ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š**

```
########################################
#  è™šæ‹Ÿç½‘ç»œè®¾å¤‡é©±åŠ¨ç¨‹åº - å®éªŒäºŒ       #
#  Advanced Computer Networks Lab      #
########################################
[VNETDEV] Vnetdev_InitModule() è¢«è°ƒç”¨!
[VNETDEV] é©±åŠ¨ç‰ˆæœ¬: 1.0
[VNETDEV] ç½‘ç»œè®¾å¤‡ 'vnet0' æ³¨å†ŒæˆåŠŸ!
...
[VNETDEV] Vnetdev_Open() è¢«è°ƒç”¨!
[VNETDEV] è®¾å¤‡åç§°: vnet0
[VNETDEV] ç½‘å¡æ­£åœ¨å¯åŠ¨...
```

---

### ç¬¬äº”æ­¥ï¼šç¼–è¯‘å¹¶è¿è¡Œè§¦å‘ç¨‹åº

```bash
# è¿›å…¥è§¦å‘ç¨‹åºç›®å½•
cd ../trigger

# ç¼–è¯‘
make

# è¿è¡Œï¼ˆéœ€è¦sudoï¼‰
sudo ./raw_trigger
```

**æˆåŠŸè¾“å‡ºï¼š**

```
========================================
  è™šæ‹Ÿç½‘å¡é©±åŠ¨è§¦å‘ç¨‹åº - å®éªŒäºŒ
========================================

[INFO] RAWå¥—æ¥å£åˆ›å»ºæˆåŠŸ
[INFO] è®¾å¤‡ vnet0 æ¥å£ç´¢å¼•: 5
...
[SEND] ç¬¬ 1 ä¸ªæ•°æ®åŒ…å‘é€æˆåŠŸ!
[SEND] ç¬¬ 2 ä¸ªæ•°æ®åŒ…å‘é€æˆåŠŸ!
[SEND] ç¬¬ 3 ä¸ªæ•°æ®åŒ…å‘é€æˆåŠŸ!
...
```

---

### ç¬¬å…­æ­¥ï¼šè§¦å‘é©±åŠ¨å…¶ä»–å‡½æ•°

```bash
# ä¿®æ”¹MTUï¼Œè§¦å‘ Vnetdev_ChangeMtu()
sudo ifconfig vnet0 mtu 1222

# æŸ¥çœ‹é©±åŠ¨æ‰“å°
dmesg | tail -20
```

---

### ç¬¬ä¸ƒæ­¥ï¼šæŸ¥çœ‹å®Œæ•´æ—¥å¿—å¹¶æˆªå›¾

```bash
# æ˜¾ç¤ºMACåœ°å€ + é©±åŠ¨æ—¥å¿—ï¼ˆç”¨äºæˆªå›¾ï¼‰
echo "=== ç½‘å¡ä¿¡æ¯ ===" && ifconfig vnet0 && echo "" && echo "=== é©±åŠ¨æ—¥å¿— ===" && dmesg | tail -40
```

**ğŸ“¸ æ­¤æ—¶æˆªå›¾ï¼** åŒ…å« MAC åœ°å€å’Œé©±åŠ¨è¿è¡Œä¿¡æ¯ã€‚

---

### ç¬¬å…«æ­¥ï¼šå¸è½½é©±åŠ¨

```bash
# å…³é—­ç½‘å¡
sudo ifconfig vnet0 down

# å¸è½½é©±åŠ¨æ¨¡å—
sudo rmmod netdrv

# éªŒè¯å·²å¸è½½
dmesg | tail -10
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q: make æŠ¥é”™ "No such file or directory"ï¼Ÿ

```bash
# ç¡®ä¿å®‰è£…äº†å†…æ ¸å¤´æ–‡ä»¶
sudo apt install linux-headers-$(uname -r)
```

### Q: insmod æŠ¥é”™ "Invalid module format"ï¼Ÿ

é©±åŠ¨å¿…é¡»åœ¨ç›®æ ‡ç³»ç»Ÿä¸Šç¼–è¯‘ã€‚é‡æ–° `make clean && make`ã€‚

### Q: ifconfig æ‰¾ä¸åˆ° vnet0ï¼Ÿ

```bash
# ç¡®ä¿é©±åŠ¨å·²åŠ è½½
lsmod | grep netdrv
# å¦‚æœæ²¡æœ‰è¾“å‡ºï¼Œé‡æ–° insmod
```

### Q: å…±äº«æ–‡ä»¶å¤¹çœ‹ä¸åˆ°ï¼Ÿ

```bash
# å®‰è£… VMware å·¥å…·
sudo apt install open-vm-tools open-vm-tools-desktop -y
# é‡å¯è™šæ‹Ÿæœº
sudo reboot
```

### Q: dmesg æ²¡æœ‰è¾“å‡ºï¼Ÿ

```bash
# ä½¿ç”¨ sudo æŸ¥çœ‹
sudo dmesg | tail -50
```

---

## ğŸ“¸ æˆªå›¾è¦æ±‚

æˆªå›¾å¿…é¡»åŒ…å«ï¼š

1. âœ… é©±åŠ¨åŠ è½½ä¿¡æ¯ï¼ˆdmesg è¾“å‡ºï¼‰
2. âœ… MAC åœ°å€ä¿¡æ¯ï¼ˆifconfig è¾“å‡ºï¼‰
3. âš ï¸ **å¿…é¡»åœ¨åŒä¸€å¼ å›¾å†…ï¼**

### æ¨èæˆªå›¾å‘½ä»¤

```bash
clear && echo "=== MACåœ°å€ ===" && ifconfig vnet0 | head -5 && echo "" && echo "=== é©±åŠ¨æ—¥å¿— ===" && dmesg | grep VNETDEV | tail -30
```
